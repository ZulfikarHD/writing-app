---
name: FG-06.3 Writing Tools
overview: Implement Writing Tools for the manuscript editor, including Scene Beats workflow (beat sections with AI expansion), Subplots integration in editor (linking scenes to subplot codex entries via progressions), enhanced text formatting options, and highlighter/marker tools - modeled after NovelCrafter's write interface.
todos:
  - id: highlight-extension
    content: Create HighlightMark.ts TipTap extension with color support
    status: completed
  - id: highlight-toolbar
    content: Add highlight button with color picker to EditorToolbar.vue
    status: completed
  - id: beat-expand-ui
    content: Add 'Expand to Prose' action to beat section type in SectionHeader.vue
    status: completed
  - id: beat-completion
    content: Add completion tracking for beat sections (is_completed field)
    status: completed
  - id: subplot-assignment
    content: Add subplot selector to SceneMetadataPanel.vue with progression creation
    status: completed
  - id: subplot-api
    content: Create API endpoints for scene subplot assignment
    status: completed
  - id: blockquote-toolbar
    content: Add block quote button to EditorToolbar.vue
    status: completed
  - id: integration-testing
    content: Integration tests for highlights, beats, and subplot assignment
    status: completed
---

# FG-06.3: Writing Tools - Development Strategy

## PHASE 1: Feature Understanding

FG-06.3 enables writers to use advanced writing tools within the manuscript editor:

- **Scene Beats Workflow**: Plan scenes using beat sections (bullet points or detailed paragraphs), then expand them to prose with AI
- **Subplots in Editor**: Track subplots through scenes using Codex Progressions; view subplot matrix in Plan interface
- **Formatting Text**: Enhanced text formatting (bold, italic, underline, strikethrough, headings, block quotes, alignment, bullet/numbered lists)
- **Highlighter/Marker Tool**: Highlight text with configurable colors for revision marking, annotations

### Reference: NovelCrafter Behavior (from documentation)

**Scene Beats:**

- Beats section type stores planning content (bullet points or paragraphs)
- Type `/` in editor and select "codex addition" to create subplot progressions
- Beats provide context for AI prose generation
- Can expand individual beats or entire beat section to prose

**Subplots:**

- Subplots stored as Codex entries (type: `subplot`)
- Track through story using Codex Progressions (additions) linked to scenes
- View subplot timeline in Plan interface Matrix view
- Subplots can be filtered/searched

**Formatting Text:**

- Format menu appears on text selection
- Bold, italic, underline, strikethrough
- Highlight with colors
- Block quotes
- Headings
- Bullet points (numeric or list)

---

## PHASE 2: Cross-Frontend Impact Mapping

| Feature | Owner (Creates) | Consumer (Uses) | Data Flow |

|---------|-----------------|-----------------|-----------|

| Scene Beats | Writer creates beat sections | Writer views/expands beats | Beat section -> AI -> Prose |

| Subplots | Writer creates subplot Codex entry | Writer assigns via progressions | CodexEntry (subplot) -> CodexProgression -> Scene |

| Formatting | System (built-in) | Writer applies formatting | TipTap commands -> Editor content |

| Highlighter | Writer highlights text | Writer finds/filters highlights | Mark -> Stored in content JSON |

---

## PHASE 3: Missing Implementation Detection

### Owner Side (Backend/Services)

- [x] `SceneSection` model with beat type (exists)
- [x] `CodexEntry` with subplot type constant (exists: `TYPE_SUBPLOT`)
- [x] `CodexProgression` model (exists - links entries to scenes)
- [x] `SectionNode` TipTap extension (exists)
- [ ] **MISSING**: Beat expansion service (AI beat to prose)
- [ ] **MISSING**: Subplot assignment UI in editor metadata
- [ ] **MISSING**: Highlight mark extension for TipTap
- [ ] **MISSING**: API endpoints for highlight operations

### Consumer Side (Frontend)

- [x] `TipTapEditor.vue` - Editor with section support (exists)
- [x] `SceneMetadataPanel.vue` - Scene metadata sidebar (exists)
- [x] `SectionNodeView.vue` - Section rendering (exists)
- [x] Basic formatting (bold, italic, underline, strike, headings, lists, alignment) (exists)
- [x] `ProgressionEditorModal.vue` - Create/edit progressions (exists)
- [ ] **MISSING**: Beat-specific section UI (expand to prose button)
- [ ] **MISSING**: Subplot selector in scene metadata
- [ ] **MISSING**: Subplot indicators on scene cards
- [ ] **MISSING**: Highlighter toolbar button and color picker
- [ ] **MISSING**: Block quote formatting option
- [ ] **MISSING**: Find highlighted text feature

### Integration Points

- [ ] Extend beat section to show "Expand to Prose" action
- [ ] Scene metadata panel: Add subplot assignment dropdown
- [ ] TipTap: Add highlight mark extension with colors
- [ ] TipTap: Add blockquote formatting to toolbar
- [ ] Editor sidebar: Show subplot filter option

---

## PHASE 4: Gap Analysis

| Gap | Severity | Impact |

|-----|----------|--------|

| No beat expansion UI | HIGH | Writers cannot easily expand beats to prose |

| No subplot assignment in editor | MEDIUM | Must use Codex interface instead of inline |

| No highlighter extension | MEDIUM | Cannot mark text for revision |

| No block quote in toolbar | LOW | Format accessible via markdown syntax |

| No highlighted text finder | LOW | Manual search required |

---

## PHASE 5: Implementation Sequencing

### P0 (Critical) - Must have for feature to work

1. **Beat Section Enhancement**

   - Add "Expand to Prose" action in beat section header
   - Connect to existing `ProseGenerationPanel` with beat content as context
   - Track beat completion status

2. **Highlight Mark Extension**

   - File: [`resources/js/extensions/HighlightMark.ts`](resources/js/extensions/HighlightMark.ts)
   - TipTap mark extension with configurable colors
   - Stores highlight color and optional note in content JSON

3. **Highlighter Toolbar Component**

   - File: [`resources/js/components/editor/HighlightToolbar.vue`](resources/js/components/editor/HighlightToolbar.vue)
   - Color picker with preset colors
   - Remove highlight option

### P1 (Important) - Feature incomplete without

4. **Subplot Assignment in Scene Metadata**

   - Extend `SceneMetadataPanel.vue` with subplot selector
   - Fetch subplot codex entries for the novel
   - Create/remove progressions linking scene to subplot

5. **Block Quote Support**

   - Already in StarterKit, expose in toolbar
   - Add toolbar button and keyboard shortcut

6. **Beat Completion Tracking**

   - Add `is_completed` field to beat-type sections
   - Visual indicator for completed beats
   - Progress tracking for scene beats

### P2 (Enhancement) - Can ship later

7. **Find Highlighted Text**

   - Scan document for highlight marks
   - List with click-to-navigate
   - Filter by highlight color

8. **Subplot Filter in Sidebar**

   - Filter scene list by assigned subplot
   - Visual indicator on scene cards

9. **Matrix View for Subplots**

   - Plan interface subplot matrix (separate feature)
   - Out of scope for editor-focused FG-06.3

---

## PHASE 6: Detailed File Changes

### New Files

**[`resources/js/extensions/HighlightMark.ts`](resources/js/extensions/HighlightMark.ts)**

```typescript
// TipTap mark extension for text highlighting
// Attributes: color (hex), note (optional)
// Commands: setHighlight(color), removeHighlight
```

**[`resources/js/components/editor/HighlightToolbar.vue`](resources/js/components/editor/HighlightToolbar.vue)**

```vue
// Color picker dropdown with preset colors
// Yellow, Green, Blue, Pink, Orange
// Custom color option
// Remove highlight button
```

**[`resources/js/composables/useHighlights.ts`](resources/js/composables/useHighlights.ts)**

```typescript
// Find all highlights in document
// Group by color
// Navigate to highlight
```

### Modified Files

**[`resources/js/components/editor/TipTapEditor.vue`](resources/js/components/editor/TipTapEditor.vue)**

- Import and register HighlightMark extension
- Expose highlight commands to parent

**[`resources/js/components/editor/EditorToolbar.vue`](resources/js/components/editor/EditorToolbar.vue)**

- Add highlight button with color dropdown
- Add block quote toggle button

**[`resources/js/components/editor/SectionNodeView.vue`](resources/js/components/editor/SectionNodeView.vue)** or **[`SectionHeader.vue`](resources/js/components/editor/SectionHeader.vue)**

- For beat type: Add "Expand to Prose" action
- Show completion toggle for beats
- Track beat completion visually

**[`resources/js/components/editor/panels/SceneMetadataPanel.vue`](resources/js/components/editor/panels/SceneMetadataPanel.vue)**

- Add "Subplots" section with multi-select dropdown
- Fetch subplot codex entries via API
- Create CodexProgression records on selection
- Show assigned subplots with color indicators

**[`app/Models/Scene.php`](app/Models/Scene.php)**

- Add `subplots()` relationship via progressions

**[`routes/spa-api.php`](routes/spa-api.php)**

- `GET /api/novels/{novel}/subplots` - List subplot entries
- `POST /api/scenes/{scene}/subplots` - Assign subplot
- `DELETE /api/scenes/{scene}/subplots/{codex_entry}` - Remove subplot

---

## PHASE 7: Example User Journeys

### Journey 1: Create and Expand Scene Beats

**Writer Journey:**

1. Writer opens scene in editor
2. Uses slash command `/beat` or section menu to insert beat section
3. Types bullet points: "- Elena opens the mysterious letter\n- She discovers her father's secret\n- Emotional breakdown"
4. Clicks "Expand to Prose" button on beat section header
5. ProseGenerationPanel opens with beats pre-filled as context
6. Writer selects prose prompt and generates
7. AI-generated prose appears in generation panel
8. Writer clicks "Add as Content" to create content section with prose
9. Writer can mark beats as completed with checkbox

### Journey 2: Assign Scene to Subplot

**Writer Journey:**

1. Writer is editing a scene about the romance subplot
2. Opens Scene Info panel (Ctrl+I or info button)
3. Scrolls to "Subplots" section
4. Clicks dropdown, sees available subplots: "Main Quest", "Romance", "Revenge"
5. Selects "Romance" subplot
6. System creates CodexProgression linking scene to subplot entry
7. Subplot badge appears in scene metadata
8. Later, writer can filter scenes by subplot or view in matrix

### Journey 3: Highlight Text for Revision

**Writer Journey:**

1. Writer selects awkward paragraph for revision
2. Clicks highlight button in toolbar
3. Color picker shows preset colors (Yellow, Pink, Green, Blue, Orange)
4. Selects "Pink" for "needs work" personal convention
5. Selected text highlighted with pink background
6. Highlight persists in saved content
7. Later, writer uses "Find Highlights" to list all highlighted passages
8. Clicks item to jump to that location
9. After revision, removes highlight

---

## Technical Notes

### Highlight Mark Implementation

```typescript
// HighlightMark.ts
import { Mark, mergeAttributes } from '@tiptap/core';

export const HighlightMark = Mark.create({
  name: 'highlight',
  addAttributes() {
    return {
      color: { default: '#fef08a' }, // Yellow default
    };
  },
  parseHTML() {
    return [{ tag: 'mark' }];
  },
  renderHTML({ HTMLAttributes }) {
    return ['mark', mergeAttributes(HTMLAttributes, {
      style: `background-color: ${HTMLAttributes.color}`,
    }), 0];
  },
  addCommands() {
    return {
      setHighlight: (color) => ({ commands }) => commands.setMark(this.name, { color }),
      toggleHighlight: (color) => ({ commands }) => commands.toggleMark(this.name, { color }),
      unsetHighlight: () => ({ commands }) => commands.unsetMark(this.name),
    };
  },
});
```

### Subplot Assignment via Progressions

```php
// Scene model - add relationship
public function subplots(): BelongsToMany
{
    return $this->belongsToMany(CodexEntry::class, 'codex_progressions', 'scene_id', 'codex_entry_id')
        ->where('type', CodexEntry::TYPE_SUBPLOT);
}
```

### Beat Expansion Context

When expanding beats to prose, pass beat content as additional context:

```typescript
// In SectionNodeView.vue
const expandBeatToProse = () => {
  const beatContent = extractTextFromSection();
  emit('expand-beat', {
    content: beatContent,
    sectionId: props.node.attrs.id,
  });
};
```

---

## Dependencies

- **FG-06.1**: Sections System (completed - beat section type exists)
- **FG-06.2**: AI Writing Features (completed - ProseGenerationPanel exists)
- **EPIC-02**: Codex (completed - CodexEntry, CodexProgression exist)

## Existing Code to Leverage

- `SceneSection` model with `TYPE_BEAT` constant
- `CodexEntry` model with `TYPE_SUBPLOT` constant  
- `CodexProgression` model for scene-entry linking
- `ProseGenerationPanel.vue` for beat expansion
- `ProgressionEditorModal.vue` for creating progressions
- Basic formatting in TipTap StarterKit (bold, italic, etc.)
