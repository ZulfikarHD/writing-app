---
name: FG-06.2 AI Writing Features
overview: Implement AI Writing Features for the manuscript editor, including prose generation with streaming, text replacement prompts (expand/rephrase/shorten), enhanced slash commands with AI integration, and format menu AI options - modeled after NovelCrafter's write interface.
todos:
  - id: backend-prose-service
    content: Create ProseGenerationService with streaming support and context building
    status: completed
  - id: backend-replacement-service
    content: Create TextReplacementService with expand/rephrase/shorten logic
    status: completed
  - id: backend-api-endpoints
    content: Create ProseGenerationController and TextReplacementController with SSE streaming
    status: completed
  - id: frontend-prose-panel
    content: Create ProseGenerationPanel.vue with beat input, prompt selector, streaming output
    status: completed
  - id: frontend-replacement-menu
    content: Create TextReplacementMenu.vue with selection bubble and AI options
    status: completed
  - id: frontend-preview-component
    content: Create ReplacementPreview.vue for before/after comparison
    status: completed
  - id: frontend-composables
    content: Create useProseGeneration.ts and useTextReplacement.ts composables
    status: completed
  - id: extend-slash-commands
    content: Add AI commands to SlashCommands.ts (continue, scene-beat, expand)
    status: completed
  - id: editor-integration
    content: Integrate AI components into TipTapEditor.vue
    status: completed
  - id: seed-system-prompts
    content: Create database seeder for default replacement prompts
    status: completed
---

# FG-06.2: AI Writing Features - Development Strategy

## PHASE 1: Feature Understanding

FG-06.2 enables writers to leverage AI directly within the manuscript editor for:

- **Prose Generation**: Generate prose from beats/instructions at cursor position with streaming output
- **Text Replacement**: Transform selected text (expand, rephrase, shorten) using AI
- **Slash Commands**: Quick `/` commands for AI actions inline
- **Format Menu AI**: AI options appear when selecting text

### Reference: NovelCrafter Behavior (from documentation)

**Generating Prose:**

- Type `/` in editor to open slash command menu
- Select "scene beat" or "continue writing"
- Enter instructions/beats in a popup interface
- Select prompt and model from dropdown
- Post-generation options: Apply, Retry, Discard, Section

**Text Replacement:**

- Select 4+ words to trigger replacement menu
- System prompts: Expand, Rephrase, Shorten
- Expand: control amount and method
- Rephrase: change POV, tense, add inner thoughts, convert to dialogue, etc.
- Shorten: Half, Quarter, Single Paragraph
- "Tweak and Generate" for custom instructions
- Square bracket instructions for inline edits

---

## PHASE 2: Cross-Frontend Impact Mapping

| Feature | Owner (Creates) | Consumer (Uses) | Data Flow |

|---------|-----------------|-----------------|-----------|

| Prose Generation | Writer in Editor | Writer sees streaming output | Prompt + Context -> AI -> Streamed text into editor |

| Text Replacement | Writer selects text | Writer sees transformed text | Selected text + Prompt -> AI -> Replacement preview |

| Slash Commands | System (predefined + custom prompts) | Writer types `/` | Command list -> Action execution |

| Format Menu AI | Writer selects text | Writer picks AI option | Selection -> AI Menu -> Transformation |

---

## PHASE 3: Missing Implementation Detection

### Owner Side (Backend/Services)

- [x] `ChatService.php` - Streaming AI responses (exists)
- [x] `AIServiceFactory.php` - Provider abstraction (exists)
- [x] `Prompt` model with types: chat, prose, replacement, summary (exists)
- [ ] **MISSING**: `ProseGenerationService` - Dedicated service for prose generation
- [ ] **MISSING**: `TextReplacementService` - Dedicated service for text transformations
- [ ] **MISSING**: API endpoints for prose generation and text replacement
- [ ] **MISSING**: Default system prompts for replacement (expand, rephrase, shorten)

### Consumer Side (Frontend)

- [x] `TipTapEditor.vue` - Editor with extensions (exists)
- [x] `SlashCommands.ts` - Basic slash command infrastructure (exists)
- [x] `SlashCommandsList.vue` - Popup for slash commands (exists)
- [ ] **MISSING**: AI Slash Commands (Continue Writing, Scene Beat, etc.)
- [ ] **MISSING**: `ProseGenerationPanel.vue` - Beat input + model selection + streaming output
- [ ] **MISSING**: `TextReplacementMenu.vue` - Selection bubble with AI options
- [ ] **MISSING**: `TransformationPreview.vue` - Preview before accepting
- [ ] **MISSING**: `FormatMenuAI.vue` - AI section in format menu
- [ ] **MISSING**: Streaming output visualization in editor

### Integration Points

- [ ] API: `POST /api/scenes/{scene}/generate-prose`
- [ ] API: `POST /api/text/replace`
- [ ] Context builder integration (scene content, codex, beats)
- [ ] Undo/Redo support for AI-generated content
- [ ] Mobile-responsive selection menu

---

## PHASE 4: Gap Analysis

| Gap | Severity | Impact |

|-----|----------|--------|

| No prose generation service | HIGH | Writers cannot generate prose inline |

| No text replacement service | HIGH | Writers cannot transform selected text |

| No AI slash commands | MEDIUM | Workflow less efficient |

| No format menu AI | MEDIUM | AI options not accessible on selection |

| No streaming visualization | HIGH | Poor UX during generation |

| No default replacement prompts | HIGH | No built-in expand/rephrase/shorten |

---

## PHASE 5: Implementation Sequencing

### P0 (Critical) - Must have for feature to work

1. **Backend: ProseGenerationService** (depends on: ChatService)

   - File: `app/Services/Editor/ProseGenerationService.php`
   - Streaming prose generation with context awareness

2. **Backend: TextReplacementService** (depends on: ChatService)

   - File: `app/Services/Editor/TextReplacementService.php`
   - Text transformation with replacement preview

3. **Backend: API Endpoints**

   - File: `app/Http/Controllers/ProseGenerationController.php`
   - `POST /api/scenes/{scene}/generate-prose`
   - `POST /api/text/replace`

4. **Frontend: ProseGenerationPanel.vue**

   - Beat/instruction input textarea
   - Prompt/model selector
   - Streaming output display
   - Accept/Retry/Discard/Section buttons

5. **Frontend: TextReplacementMenu.vue**

   - Selection bubble trigger (4+ words)
   - Built-in options: Expand, Rephrase, Shorten
   - Custom prompt option
   - Preview panel

### P1 (Important) - Feature incomplete without

6. **AI Slash Commands Extension**

   - Extend `SlashCommands.ts` with AI commands
   - Commands: `/continue`, `/scene-beat`, `/expand`, `/dialogue`
   - Connect to ProseGenerationPanel

7. **Default System Prompts (Seeder)**

   - Database seeder for replacement prompts
   - Expand, Rephrase, Shorten system prompts
   - Prompt inputs for each

8. **Streaming Visualization**

   - Typing indicator in editor
   - Progressive text rendering
   - Cursor position management

### P2 (Enhancement) - Can ship later

9. **Format Menu AI Options**

   - Integrate AI section into TipTap bubble menu
   - Quick access to replacement prompts

10. **Custom Prompt Integration**

    - User can add their own slash commands
    - Link prompts to slash menu

---

## PHASE 6: Detailed File Changes

### New Backend Files

**`app/Services/Editor/ProseGenerationService.php`**

- Purpose: Handle prose generation with streaming
- Methods: `generate()`, `buildContext()`, `streamResponse()`
- Leverage existing `ChatService` streaming infrastructure

**`app/Services/Editor/TextReplacementService.php`**

- Purpose: Handle text transformations
- Methods: `replace()`, `expand()`, `rephrase()`, `shorten()`
- Built-in transformation logic

**`app/Http/Controllers/ProseGenerationController.php`**

- Endpoint: `POST /api/scenes/{scene}/generate-prose`
- Request validation: prompt_id, model, instructions, beat_content
- Streams SSE response

**`app/Http/Controllers/TextReplacementController.php`**

- Endpoint: `POST /api/text/replace`
- Request validation: selected_text, prompt_id, transformation_type, options

### New Frontend Files

**`resources/js/components/editor/ProseGenerationPanel.vue`**

- Beat/instruction textarea
- Prompt selector dropdown
- Model selector
- Generate button with dropdown for prompt selection
- Streaming output container
- Action buttons: Apply, Retry, Discard, Add to Section

**`resources/js/components/editor/TextReplacementMenu.vue`**

- Floating menu on text selection
- Expand/Rephrase/Shorten quick options
- "More prompts" submenu
- Tweak and Generate option

**`resources/js/components/editor/ReplacementPreview.vue`**

- Side-by-side: Original vs Replacement
- Accept/Reject buttons
- Retry with different model

**`resources/js/composables/useProseGeneration.ts`**

- SSE streaming handler
- State management for generation
- Retry/abort logic

**`resources/js/composables/useTextReplacement.ts`**

- Selection state tracking
- Replacement API calls
- Preview state management

### Modified Files

**`resources/js/extensions/SlashCommands.ts`**

- Add AI commands: Continue Writing, Scene Beat, Expand Selection, etc.
- Command callback opens ProseGenerationPanel

**`resources/js/components/editor/TipTapEditor.vue`**

- Import and render ProseGenerationPanel
- Import and render TextReplacementMenu
- Handle text selection events

**`routes/spa-api.php`**

- Add prose generation routes
- Add text replacement routes

---

## PHASE 7: Example User Journeys

### Journey 1: Generate Prose from Beat

**Writer Journey:**

1. Writer positions cursor at end of paragraph in editor
2. Types `/` to open slash command menu
3. Selects "Scene Beat" command
4. ProseGenerationPanel opens inline
5. Writer types beat: "Elena discovers the hidden letter in the drawer. Emotional reaction."
6. Clicks dropdown arrow next to play button, selects preferred prompt
7. Clicks play button to generate
8. Sees streaming prose appear in generation panel
9. Reads generated content, clicks "Apply"
10. Generated prose inserted at cursor position
11. Can immediately Ctrl+Z to undo if needed

### Journey 2: Text Replacement (Expand)

**Writer Journey:**

1. Writer selects a paragraph of text (4+ words)
2. TextReplacementMenu bubble appears above selection
3. Writer clicks "Expand" option
4. Quick menu shows: "Default", "Add sensory details", "Add inner thoughts"
5. Writer clicks "Add sensory details"
6. Loading state shows while AI generates
7. ReplacementPreview shows original vs expanded text
8. Writer clicks "Accept"
9. Original text replaced with expanded version
10. Ctrl+Z available for undo

### Journey 3: Slash Command Continue Writing

**Writer Journey:**

1. Writer is at end of a scene, unsure how to continue
2. Types `/continue`
3. ProseGenerationPanel opens with "Continue Writing" prompt pre-selected
4. Writer optionally adds guidance: "Build tension"
5. Clicks generate
6. AI continues the prose naturally from current context
7. Writer reviews, clicks "Apply" or "Retry" for different output

---

## Technical Notes

### Streaming Implementation

Use SSE (Server-Sent Events) pattern from existing `ChatService`:

```php
// ProseGenerationController.php
public function generate(Request $request, Scene $scene)
{
    return response()->stream(function () use ($request, $scene) {
        foreach ($this->service->generate($scene, $request->all()) as $chunk) {
            echo "data: " . json_encode($chunk) . "\n\n";
            ob_flush();
            flush();
        }
    }, 200, ['Content-Type' => 'text/event-stream']);
}
```

### Context Building

Leverage existing context building from `ChatService`:

- Scene content (before cursor)
- Scene beats/summary
- Codex entries (AI-visible only)
- Novel settings (genre, POV, tense)

### TipTap Integration

Insert generated text using TipTap commands:

```typescript
editor.chain()
  .focus()
  .insertContent(generatedText)
  .run();
```

For replacement:

```typescript
editor.chain()
  .focus()
  .deleteSelection()
  .insertContent(replacementText)
  .run();
```
