---
name: FG-04.2 Context Integration
overview: Implement the Context & Integration feature group for the Workshop Chat, enabling writers to inject novel context (scenes, codex entries, outlines) into AI conversations with a visual preview and token counting system.
todos:
  - id: backend-token-service
    content: Create TokenCounterService for token estimation
    status: completed
  - id: backend-context-api
    content: Add context CRUD endpoints to ChatController/ChatContextController
    status: completed
  - id: frontend-context-selector
    content: Build ContextSelector.vue component with search and multi-select
    status: completed
  - id: frontend-context-preview
    content: Build ContextPreview.vue modal with token counts and toggles
    status: completed
  - id: update-chat-input
    content: Add context button and badge to ChatInput.vue
    status: completed
  - id: chat-with-scene
    content: Add 'Chat with scene' button to editor toolbar
    status: in_progress
  - id: pinnable-panel
    content: Implement pinnable chat panel in workspace layout
    status: pending
  - id: composable-context
    content: Create useChatContext.ts composable for state management
    status: completed
  - id: tests
    content: Write tests for context API and token counting
    status: pending
---

# FG-04.2: Context & Integration Development Strategy

## Feature Analysis Summary

Based on the EPIC specification and NovelCrafter reference, this feature group enables:

- Injecting novel context (scenes, codex, summaries, outlines) into chat conversations
- Contextual chat from within the editor ("Chat with this scene")
- Pinnable chat panel beside the editor
- Token counting and context preview

---

## Cross-Frontend Impact Mapping

| Feature | Owner (Who Creates) | Consumer (Who Views) | Data Flow |

|---------|---------------------|---------------------|-----------|

| F-04.2.1 Context Injection | Chat Panel + Context Selector | AI System Message | User selects -> Store in `chat_context_items` -> Build system prompt |

| F-04.2.2 Chat with Scene | Editor/Write Panel | Chat Panel | Click "Chat with scene" -> Create thread with `linked_scene_id` -> Auto-load context |

| F-04.2.3 Pin Chat Panel | Chat Header/Workspace | Workspace Layout | Toggle pin -> Store in thread -> Render split view |

| F-04.2.4 Context Preview | Context Selector | Preview Modal/Panel | Select items -> Calculate tokens -> Display preview |

---

## Current Implementation State

**Backend (Mostly Ready):**

- `ChatContextItem` model exists with `context_type` (scene, codex, summary, outline, custom)
- `ChatThread` has `linked_scene_id`, `context_settings`, relationships to `contextItems`
- `ChatService::buildSystemMessage()` already processes context items
- Missing: API endpoints for context CRUD, token counting endpoint

**Frontend (Needs Implementation):**

- Chat components exist: `ChatPanel`, `ChatWindow`, `ChatInput`, `ChatHeader`, `ChatMessage`
- No context-related components exist
- No token counting or preview UI
- No "Chat with scene" integration in editor

---

## Gap Analysis

| Component | Status | Priority |

|-----------|--------|----------|

| ContextSelector.vue | Missing | P0 |

| ContextPreview.vue | Missing | P0 |

| Context API endpoints | Missing | P0 |

| Token counting service | Missing | P0 |

| "Chat with scene" button in editor | Missing | P1 |

| Pin chat panel UI | Missing | P1 |

| Split workspace layout | Missing | P1 |

| ChatInput context button | Missing | P0 |

| Context badge/indicator | Missing | P1 |

---

## Implementation Sequencing

### Phase 1: Backend Context Management (P0)

**1.1 Token Counting Service**

Create `app/Services/Chat/TokenCounterService.php`:

- Estimate tokens using character-based approximation (chars/4)
- Support for different context types
- Return breakdown per item

**1.2 Context API Endpoints**

Add to `ChatController` or create `ChatContextController`:

- `GET /api/chat/threads/{thread}/context` - List context items
- `POST /api/chat/threads/{thread}/context` - Add context item
- `PATCH /api/chat/context/{item}` - Toggle active/update
- `DELETE /api/chat/context/{item}` - Remove context
- `GET /api/chat/threads/{thread}/context/preview` - Get full context text with tokens
- `GET /api/novels/{novel}/context-sources` - List available sources (scenes, codex)

**1.3 Update ChatService**

Enhance `buildSystemMessage()` to:

- Better structure context by type
- Store context snapshot in message record
- Respect `ai_context_mode` from codex entries

### Phase 2: Frontend Context Selector (P0)

**2.1 ContextSelector.vue**

Location: `resources/js/components/chat/ContextSelector.vue`

- Searchable dropdown to add context
- Group by type (Scenes, Codex, Outline, Custom)
- Show token estimate per item
- Support multi-select

**2.2 ContextPreview.vue**

Location: `resources/js/components/chat/ContextPreview.vue`

- Modal/drawer showing full context text
- Token count per item and total
- Toggle items on/off
- Remove items
- Token limit warnings (configurable per model)

**2.3 Update ChatInput.vue**

- Add "+ Context" button next to message input
- Show context badge with item count
- Click to open ContextPreview

**2.4 ContextBadge.vue**

Location: `resources/js/components/chat/ContextBadge.vue`

- Shows number of active context items
- Clickable to open preview
- Animated when adding items

### Phase 3: Chat with Scene Integration (P1)

**3.1 Update WritePanel.vue / TipTapEditor.vue**

Add "Chat about this scene" button to:

- Editor toolbar (EditorToolbar.vue)
- Selection action menu (SelectionActionMenu.vue)

**3.2 Integration Flow**

```
User clicks "Chat with scene" -> 
Create thread with linked_scene_id ->
Auto-add scene + detected codex entries as context ->
Switch to chat mode / open pinned panel
```

**3.3 Auto-detect Codex Entries**

Use existing `codex_mentions` table to auto-suggest relevant entries

### Phase 4: Pinnable Chat Panel (P1)

**4.1 Update Workspace Layout**

Modify `resources/js/pages/Workspace/Index.vue`:

- Add `pinnedChatOpen` state
- Render split view when pinned
- Persist pin state per thread

**4.2 PinnedChatPanel.vue**

Location: `resources/js/components/workspace/PinnedChatPanel.vue`

- Compact version of ChatPanel
- Resizable width
- Collapse/expand toggle
- Sync with main chat (same thread)

**4.3 Update ChatHeader.vue**

- Add pin/unpin button
- Emit event to parent workspace

---

## File Changes Summary

### New Files

**Backend:**

- `app/Services/Chat/TokenCounterService.php`
- `app/Http/Controllers/ChatContextController.php`
- `app/Http/Requests/AddContextRequest.php`

**Frontend:**

- `resources/js/components/chat/ContextSelector.vue`
- `resources/js/components/chat/ContextPreview.vue`
- `resources/js/components/chat/ContextBadge.vue`
- `resources/js/components/workspace/PinnedChatPanel.vue`
- `resources/js/composables/useChatContext.ts`

### Modified Files

**Backend:**

- `routes/spa-api.php` - Add context routes
- `app/Http/Controllers/ChatController.php` - Add context-related methods
- `app/Services/Chat/ChatService.php` - Enhance context building

**Frontend:**

- `resources/js/components/chat/ChatInput.vue` - Add context button
- `resources/js/components/chat/ChatHeader.vue` - Add pin button
- `resources/js/components/chat/ChatPanel.vue` - Pass context props
- `resources/js/components/workspace/ChatPanel.vue` - Handle pinning
- `resources/js/pages/Workspace/Index.vue` - Split layout for pinned chat
- `resources/js/components/editor/EditorToolbar.vue` - Chat with scene button
- `resources/js/composables/useChat.ts` - Add context management

---

## User Journeys

### Journey 1: Adding Context to Chat (Owner)

1. User opens Chat mode in Workspace
2. User clicks "+ Context" button near input
3. ContextSelector opens with searchable list
4. User selects "Chapter 1: Opening Scene" and "Character: Elena"
5. Items appear as badges, token count updates (e.g., "1,200 tokens")
6. User types message and sends
7. AI responds with awareness of scene and character

### Journey 2: Chat with Scene (Owner -> Consumer)

1. User is editing Scene 5 in Write mode
2. User highlights a paragraph and clicks "Chat about this"
3. System creates new thread with scene as context
4. Chat panel opens (or workspace switches to Chat mode)
5. User sees "Scene 5" badge in context area
6. User asks "How can I improve this dialogue?"
7. AI responds with scene-aware suggestions

### Journey 3: Using Pinned Chat (Consumer)

1. User is in Write mode editing a scene
2. User clicks pin icon in chat header
3. Chat panel docks to right side of editor (resizable)
4. User continues editing while chatting
5. User asks questions, AI has scene context
6. User unpins to return to full editor width

---

## Technical Considerations

**Token Estimation:**

- Use simple `strlen($text) / 4` for estimation
- Show warnings at 80% of model's context limit
- Store limits per model in config

**Performance:**

- Lazy load context sources on dropdown open
- Cache codex entries list per session
- Debounce search in ContextSelector

**Mobile/Responsive:**

- Pinned chat becomes full-screen modal on mobile
- Context selector uses bottom sheet pattern
- Collapse context to badge only

---

## Definition of Done Checklist

- [ ] Can add scenes as context
- [ ] Can add codex entries as context
- [ ] Can add custom text as context
- [ ] Token count displays correctly
- [ ] Context preview shows full text
- [ ] Can toggle context items on/off
- [ ] "Chat with scene" works from editor
- [ ] Pinnable chat panel works
- [ ] Mobile responsive
- [ ] Unit tests for TokenCounterService
- [ ] Feature tests for context API
